import os
from flask import Flask, request, abort
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import (
    MessageEvent,
    TextMessage,
    ImageMessage,
    TextSendMessage
)

from datetime import datetime
import gspread
from oauth2client.service_account import ServiceAccountCredentials

# ==============================
# LINE CONFIG (ENV)
# ==============================
LINE_CHANNEL_ACCESS_TOKEN = os.getenv("LINE_CHANNEL_ACCESS_TOKEN")
LINE_CHANNEL_SECRET = os.getenv("LINE_CHANNEL_SECRET")

line_bot_api = LineBotApi(LINE_CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(LINE_CHANNEL_SECRET)

# ==============================
# Flask
# ==============================
app = Flask(__name__)

# ==============================
# Google Sheet
# ==============================
scope = [
    "https://spreadsheets.google.com/feeds",
    "https://www.googleapis.com/auth/drive"
]

creds = ServiceAccountCredentials.from_json_keyfile_name(
    "Tomato-Sheet.json", scope
)
client = gspread.authorize(creds)

sheet = client.open_by_key(
    "1irin8ZPdTb5VX0pnFH9S4zz6RSl_chfjppxZLZ5Y2-Q"
).sheet1


def log_to_sheet(disease_name):
    now = datetime.now().strftime("%d/%m/%Y %H:%M:%S")

    # ‡∏ï‡πà‡∏≠‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏™‡∏°‡∏≠
    sheet.append_row(
        ["" for _ in range(12)] + [now, disease_name],
        value_input_option="USER_ENTERED"
    )

    print("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheet:", disease_name)


# ==============================
# AI PREDICT (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)
# ==============================
def predict_image(image_path):
    """
    ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á mock
    ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏à‡∏£‡∏¥‡∏á ‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏≠‡∏≤‡∏°‡∏≤‡πÅ‡∏ó‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    """
    return (
        "Tomato Early Blight",
        92.35,
        "ü©∫ ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô:\n- ‡∏ï‡∏±‡∏î‡πÉ‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏£‡∏Ñ\n- ‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤\n- ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏™‡∏π‡∏á"
    )


# ==============================
# CALLBACK
# ==============================
@app.route("/callback", methods=["POST"])
def callback():
    signature = request.headers.get("X-Line-Signature")
    body = request.get_data(as_text=True)

    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)
    except Exception as e:
        print("‚ùå ERROR:", e)

    return "OK"


# ==============================
# TEXT MESSAGE
# ==============================
@handler.add(MessageEvent, message=TextMessage)
def handle_text(event):
    reply = (
        "üçÖ ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®‡∏°‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö\n"
        "‡∏ú‡∏°‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÇ‡∏£‡∏Ñ‡πÉ‡∏´‡πâ üòä"
    )

    line_bot_api.reply_message(
        event.reply_token,
        TextSendMessage(text=reply)
    )


# ==============================
# IMAGE MESSAGE (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
# ==============================
@handler.add(MessageEvent, message=ImageMessage)
def handle_image(event):
    print("üì∏ Image received")

    # ‚úÖ 1. ‡∏ï‡∏≠‡∏ö LINE ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏Å‡∏±‡∏ô timeout)
    line_bot_api.reply_message(
        event.reply_token,
        TextSendMessage(
            text="üîç ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÇ‡∏£‡∏Ñ‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏® ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡∏Ñ‡∏£‡∏±‡∏ö‚Ä¶"
        )
    )

    # ‚úÖ 2. ‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏Å ‡∏ó‡∏≥‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á
    message_id = event.message.id
    content = line_bot_api.get_message_content(message_id)

    image_path = "/tmp/input.jpg"
    with open(image_path, "wb") as f:
        for chunk in content.iter_content():
            f.write(chunk)

    print("‚úÖ Image saved")

    disease, confidence, detail = predict_image(image_path)

    if disease:
        log_to_sheet(disease)

        result = (
            f"üå± ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÇ‡∏£‡∏Ñ‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®\n\n"
            f"ü¶† ‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏û‡∏ö: {disease}\n"
            f"üìä ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: {confidence:.2f}%\n\n"
            f"{detail}"
        )
    else:
        result = (
            "üì∑ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ\n"
            "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ñ‡∏£‡∏±‡∏ö üôè"
        )

    # ‚úÖ 3. ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏£‡∏≠‡∏ö‡∏™‡∏≠‡∏á (push)
    line_bot_api.push_message(
        event.source.user_id,
        TextSendMessage(text=result)
    )


# ==============================
# MAIN
# ==============================
if __name__ == "__main__":
    port = int(os.environ.get("PORT", 8080))
    app.run(host="0.0.0.0", port=port)

